---
title: 调试多线程应用程序
description: 调试在 Visual Studio 中使用线程窗口和调试位置工具栏
ms.date: 11/21/2018
ms.topic: conceptual
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: e3a87fd0480727a524b36ab209f5126b0f996c30
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "62846875"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>演练：调试多线程的应用使用线程窗口 (C#，Visual Basic 中， C++)

多个 Visual Studio 用户界面元素帮助您调试多线程应用程序。 本文介绍了在代码编辑器窗口中，多线程调试功能**调试位置**工具栏上，并**线程**窗口。 有关其他工具来调试多线程应用程序的信息，请参阅[开始调试多线程应用程序](../debugger/get-started-debugging-multithreaded-apps.md)。

完成本教程，只需要几分钟，并帮助您熟悉的调试多线程应用程序基础知识。

## <a name="create-a-multithreaded-app-project"></a>创建一个多线程应用项目

创建在本教程中使用以下多线程应用程序项目：

1. 打开 Visual Studio 并创建一个新项目。

    ::: moniker range=">=vs-2019"
    按 Esc 关闭启动窗口  。 类型**Ctrl + Q**若要打开搜索框中，键入**控制台**(或**c + +** )，选择**模板**，，然后：

    - 有关C#，选择**创建新的控制台应用 (.NET Framework) 项目**为C#。 在出现的对话框中，选择“创建”  。
    - 有关C++，选择**创建新的控制台应用项目**。 在出现的对话框中，选择“创建”  。

    然后，键入一个名称，如**MyThreadWalkthroughApp**然后单击**创建**。
    ::: moniker-end
    ::: moniker range="vs-2017"
    在顶部菜单栏，依次选择“文件”   > “新建”   > “项目”  。 在左窗格中**新的项目**对话框框中，选择以下：
    - 有关C#应用程序下**可视化C#** ，选择**Windows 桌面**，然后在中间窗格中选择**控制台应用 (.NET Framework)** 。
    - 有关C++应用程序下**可视化C++** ，选择**Windows 桌面**、，然后选择**Windows 控制台应用程序**。

    然后，键入一个名称，如**MyThreadWalkthroughApp**然后单击**确定**。
    ::: moniker-end

    如果没有看到“控制台应用”项目模板，请转到“工具” > “获取工具和功能...”，这会打开 Visual Studio 安装程序    。 选择“.NET 桌面开发”或“使用 C++ 的桌面开发”工作负载，然后选择“修改”    。

    新项目将出现在**解决方案资源管理器**，并且源文件调用*Program.cs*或*MyThreadWalkthroughApp.cpp*在源代码窗口中打开。

1. 与源文件中的代码替换为C#或C++中的示例代码[开始调试多线程应用程序](../debugger/get-started-debugging-multithreaded-apps.md)。

1. 选择**文件** > **保存所有**。

## <a name="start-debugging"></a>“启动调试”

1. 在源代码中查找以下行：

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. 上设置断点`Console.WriteLine();`通过在左侧的槽中，单击或选择行并按行**F9**。

   断点显示为代码行旁边的左滚动条槽中的红色圆圈。

1. 选择**调试** > **开始调试**，或按**F5**。

   应用在调试模式下启动，并会在断点处暂停。

1. 在中断模式下打开**线程**通过选择窗口**调试** > **Windows** > **线程**。 您必须位于一个调试会话以打开或请参阅**线程**和其他调试窗口。

## <a name="examine-thread-markers"></a>检查线程标记

1. 在源代码中，找到`Console.WriteLine();`行。

   1. 右键单击**线程**窗口中，然后选择**在源中显示线程**![源中显示线程](../debugger/media/dbg-multithreaded-show-threads.png "ThreadMarker")从菜单。

   滚动条槽旁边的源代码行现在将显示*线程标记*图标![线程标记](../debugger/media/dbg-thread-marker.png "线程标记")。 线程标记指示线程在此位置停止。 在该位置，多个已停止的线程时![多个线程](../debugger/media/dbg-multithreaded-show-threads.png "多个线程")图标将出现。

1. 将指针悬停在线程标记上。 数据提示中出现，显示已停止的线程或线程的名称和线程 ID 号。 线程名称可能是`<No Name>`。

   >[!TIP]
   >为了帮助识别无名称的线程，则可以重命名文件中**线程**窗口。 右键单击该线程，然后选择**重命名**。

1. 右键单击要查看的快捷菜单上的可用选项的源代码中的线程标记。

## <a name="flag-and-unflag-threads"></a>标记线程和取消标记线程

可以标记来跟踪你想要特别注意的线程的线程。

标记线程和取消标记线程从源代码编辑器或从**线程**窗口。 选择是否要从标记的线程或所有线程，仅显示**调试位置**或**线程**窗口工具栏。 从任何位置所做的选择会影响所有位置。

### <a name="flag-and-unflag-threads-in-source-code"></a>标记线程和取消标记在源代码中的线程

1. 打开**调试位置**通过选择工具栏**视图** > **工具栏** > **调试位置**。 此外可以右键单击工具栏区域中，然后选择**调试位置**。

1. **调试位置**工具栏具有三个字段：**进程**，**线程**，和**堆栈帧**。 下拉列表**线程**列表，并记下有多少线程。 在中**线程**列表中，当前正在执行的线程标记供 **>** 符号。

1. 在源代码窗口中，将鼠标悬停在滚动条槽中的线程标记图标，并在数据提示中选择标记图标 （或一个空的标志图标）。 标志图标将变为红色。

   此外可以右键单击一个线程的标记图标，指向**标志**，然后选择快捷菜单中的标记的线程。

1. 上**调试位置**工具栏中，选择**仅显示标记的线程**图标![显示已标记线程](../debugger/media/dbg-threads-show-flagged.png "显示已标记线程")到角**线程**字段。 除非将标记一个或多个线程，该图标将灰显。

   只有标记的线程现在显示在**线程**工具栏中的下拉列表。 若要再次显示所有线程，请选择**仅都显示标记的线程**再次图标。

   >[!TIP]
   >已标记某些线程后，可以将光标放在代码编辑器中，右键单击，然后选择**运行到光标处的已标记线程**。 请确保选择所有已标记的线程将达到的代码。 **已标记线程运行到光标处**将暂停，从而使代码更容易控制的执行顺序的选定行上的线程[冻结和解冻线程](#bkmk_freeze)。

1. 若要切换当前正在执行的线程的已标记或取消标记状态，请选择单个标志**切换当前线程已标记状态**工具栏按钮的左侧**仅显示标记的线程**按钮。 将当前线程标记可用于查找当前线程时显示标记的线程。

1. 若要取消标记线程，将鼠标悬停在源代码中的线程标记，然后选择红色标志图标可清除它，或右击线程标记并选择**取消标记**。

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>标记线程和取消标记线程窗口中的线程

在中**线程**窗口中，标记的线程具有红色标志图标旁边，未标记的线程时，如果所示，具有空的图标。

![线程窗口](../debugger/media/dbg-threads-window.png "线程窗口")

选择标记图标来更改线程状态为已标记或取消标记，具体取决于其当前状态。

此外可以右击某行，然后选择**标志**，**取消标记**，或**取消标记所有线程**从快捷菜单。

**线程**窗口工具栏还包含一些**仅显示标记的线程**按钮，这是右两个标志图标之一。 它适用于与按钮相同**调试位置**工具栏和任一按钮控制这两个位置中的显示。

### <a name="other-threads-window-features"></a>其他线程窗口功能

在中**线程**窗口中，选择任何列对线程排序，可按该列的标题。 再次选择要反转排序顺序。 如果所有线程都已都显示，选择标记图标列对线程排序标记或取消标记的状态。

第二列相交**线程**窗口 （包含任何标头中） 是**当前线程**列。 此列中的黄色箭头标记当前执行点。

**位置**列显示每个线程的源代码中的显示位置。 选择展开箭头旁边**位置**条目或悬停，该条目，以显示该线程的部分调用堆栈上。

>[!TIP]
>对于线程的调用堆栈的图形视图，使用[并行堆栈](../debugger/using-the-parallel-stacks-window.md)窗口。 若要在调试时打开窗口，请选择**调试**> **Windows** > **并行堆栈**。

除了**标志**，**取消标记**，并**取消标记所有线程**，右键单击上下文菜单**线程**窗口项具有：

- **源中显示线程**按钮。
- **十六进制显示**，更改**线程 ID**中的 s**线程**从十进制为十六进制格式的窗口。
- [切换到线程](#switch-to-another-thread)，它立即切换到该线程的执行。
- **重命名**，它可让你更改线程名称。
- [冻结和解冻](#bkmk_freeze)命令。

## <a name="bkmk_freeze"></a> 冻结和解冻线程执行

可以冻结和解冻，或挂起和恢复线程以控制线程在其中执行工作的顺序。 冻结和解冻线程可以帮助你解决并发问题，如死锁和争用条件。

> [!TIP]
> 若要操作一个线程，并且不冻结其他线程，也一种常见调试方案，请参阅[开始调试多线程应用程序](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread)。

**冻结和解冻线程：**

1. 在中**线程**窗口中，右击任何线程，然后选择**冻结**。 一个**暂停**中的图标**当前线程**列指示该线程已冻结。

1. 选择**列**中**线程**窗口工具栏中，然后选择**挂起项计数**以显示**挂起项计数**列。 冻结线程的挂起项计数值是**1**。

1. 右击冻结的线程，然后选择**解冻**。

   **暂停**图标将消失，并且**挂起项计数**值更改为**0**。

## <a name="switch-to-another-thread"></a>切换到另一个线程

你可能会看到**应用程序处于中断模式**窗口时尝试切换到另一个线程。 此窗口，通知您该线程不具有当前调试器可以显示任何代码。 例如，你可以调试托管的代码中，但该线程是本机代码。 窗口提供了解决此问题的建议。

**若要切换到另一个线程：**

1. 在中**线程**窗口中，记下当前的线程 ID，这是中的黄色箭头的线程**当前线程**列。 你将想要切换回该线程便可继续您的应用程序。

1. 右键单击另一个线程，然后选择**切换到线程**从上下文菜单。

1. 观察的黄色箭头位置已更改中**线程**窗口。 原始的当前线程标记还保留，为一个轮廓。

   在代码源编辑器中的线程标记和中的列表上查看工具提示**线程**上的下拉列表中**调试位置**工具栏。 观察也已经那里更改当前线程。

1. 上**调试位置**工具栏上，选择从不同的线程**线程**列表。 请注意，当前线程还更改在其他两个位置。

1. 在源代码编辑器中，右击线程标记，指向**切换到线程**，并从列表中选择另一个线程。 观察到，在所有三个位置更改当前线程。

与在源代码中的线程标记，你只能切换到在该位置停止的线程。 使用“线程”窗口和“调试位置”工具栏可以切换到任何线程   。

现在已了解调试多线程应用程序的基础知识。 您可以观察、 标志和取消标记，和冻结和解冻线程通过**线程**窗口中，**线程**列表中**调试位置**工具栏或中的线程标记源代码编辑器。

## <a name="see-also"></a>请参阅
- [调试多线程应用](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [如何：在调试时切换到另一个线程](../debugger/how-to-switch-to-another-thread-while-debugging.md)
